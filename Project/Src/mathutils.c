#include <stdbool.h>


#include "mathutils.h"
#include "math.h"

#define sincosMax (10000)
static const int32_t sinedata[360] = {0.0, 175.0, 349.0, 523.0, 698.0, 872.0, 1045.0, 1219.0, 1392.0, 1564.0, 1736.0, 
1908.0, 2079.0, 2250.0, 2419.0, 2588.0, 2756.0, 2924.0, 3090.0, 3256.0, 3420.0, 3584.0, 3746.0, 3907.0, 4067.0, 
4226.0, 4384.0, 4540.0, 4695.0, 4848.0, 5000.0, 5150.0, 5299.0, 5446.0, 5592.0, 5736.0, 5878.0, 6018.0, 6157.0, 
6293.0, 6428.0, 6561.0, 6691.0, 6820.0, 6947.0, 7071.0, 7193.0, 7314.0, 7431.0, 7547.0, 7660.0, 7771.0, 7880.0, 
7986.0, 8090.0, 8192.0, 8290.0, 8387.0, 8480.0, 8572.0, 8660.0, 8746.0, 8829.0, 8910.0, 8988.0, 9063.0, 9135.0, 
9205.0, 9272.0, 9336.0, 9397.0, 9455.0, 9511.0, 9563.0, 9613.0, 9659.0, 9703.0, 9744.0, 9781.0, 9816.0, 9848.0, 
9877.0, 9903.0, 9925.0, 9945.0, 9962.0, 9976.0, 9986.0, 9994.0, 9998.0, 10000.0, 9998.0, 9994.0, 9986.0, 9976.0, 
9962.0, 9945.0, 9925.0, 9903.0, 9877.0, 9848.0, 9816.0, 9781.0, 9744.0, 9703.0, 9659.0, 9613.0, 9563.0, 9511.0, 
9455.0, 9397.0, 9336.0, 9272.0, 9205.0, 9135.0, 9063.0, 8988.0, 8910.0, 8829.0, 8746.0, 8660.0, 8572.0, 8480.0, 
8387.0, 8290.0, 8192.0, 8090.0, 7986.0, 7880.0, 7771.0, 7660.0, 7547.0, 7431.0, 7314.0, 7193.0, 7071.0, 6947.0, 
6820.0, 6691.0, 6561.0, 6428.0, 6293.0, 6157.0, 6018.0, 5878.0, 5736.0, 5592.0, 5446.0, 5299.0, 5150.0, 5000.0, 
4848.0, 4695.0, 4540.0, 4384.0, 4226.0, 4067.0, 3907.0, 3746.0, 3584.0, 3420.0, 3256.0, 3090.0, 2924.0, 2756.0, 
2588.0, 2419.0, 2250.0, 2079.0, 1908.0, 1736.0, 1564.0, 1392.0, 1219.0, 1045.0, 872.0, 698.0, 523.0, 349.0, 
175.0, 0.0, -175.0, -349.0, -523.0, -698.0, -872.0, -1045.0, -1219.0, -1392.0, -1564.0, -1736.0, -1908.0, 
-2079.0, -2250.0, -2419.0, -2588.0, -2756.0, -2924.0, -3090.0, -3256.0, -3420.0, -3584.0, -3746.0, -3907.0, 
-4067.0, -4226.0, -4384.0, -4540.0, -4695.0, -4848.0, -5000.0, -5150.0, -5299.0, -5446.0, -5592.0, -5736.0, 
-5878.0, -6018.0, -6157.0, -6293.0, -6428.0, -6561.0, -6691.0, -6820.0, -6947.0, -7071.0, -7193.0, -7314.0, 
-7431.0, -7547.0, -7660.0, -7771.0, -7880.0, -7986.0, -8090.0, -8192.0, -8290.0, -8387.0, -8480.0, -8572.0, 
-8660.0, -8746.0, -8829.0, -8910.0, -8988.0, -9063.0, -9135.0, -9205.0, -9272.0, -9336.0, -9397.0, -9455.0, 
-9511.0, -9563.0, -9613.0, -9659.0, -9703.0, -9744.0, -9781.0, -9816.0, -9848.0, -9877.0, -9903.0, -9925.0, 
-9945.0, -9962.0, -9976.0, -9986.0, -9994.0, -9998.0, -10000.0, -9998.0, -9994.0, -9986.0, -9976.0, -9962.0, 
-9945.0, -9925.0, -9903.0, -9877.0, -9848.0, -9816.0, -9781.0, -9744.0, -9703.0, -9659.0, -9613.0, -9563.0, 
-9511.0, -9455.0, -9397.0, -9336.0, -9272.0, -9205.0, -9135.0, -9063.0, -8988.0, -8910.0, -8829.0, -8746.0, 
-8660.0, -8572.0, -8480.0, -8387.0, -8290.0, -8192.0, -8090.0, -7986.0, -7880.0, -7771.0, -7660.0, -7547.0, 
-7431.0, -7314.0, -7193.0, -7071.0, -6947.0, -6820.0, -6691.0, -6561.0, -6428.0, -6293.0, -6157.0, -6018.0, 
-5878.0, -5736.0, -5592.0, -5446.0, -5299.0, -5150.0, -5000.0, -4848.0, -4695.0, -4540.0, -4384.0, -4226.0, 
-4067.0, -3907.0, -3746.0, -3584.0, -3420.0, -3256.0, -3090.0, -2924.0, -2756.0, -2588.0, -2419.0, -2250.0, 
-2079.0, -1908.0, -1736.0, -1564.0, -1392.0, -1219.0, -1045.0, -872.0, -698.0, -523.0, -349.0, -175.0};

static const int32_t cosinedata[360] = {10000.0, 9998.0, 9994.0, 9986.0, 9976.0, 9962.0, 9945.0, 9925.0, 9903.0, 
9877.0, 9848.0, 9816.0, 9781.0, 9744.0, 9703.0, 9659.0, 9613.0, 9563.0, 9511.0, 9455.0, 9397.0, 9336.0, 
9272.0, 9205.0, 9135.0, 9063.0, 8988.0, 8910.0, 8829.0, 8746.0, 8660.0, 8572.0, 8480.0, 8387.0, 8290.0, 
8192.0, 8090.0, 7986.0, 7880.0, 7771.0, 7660.0, 7547.0, 7431.0, 7314.0, 7193.0, 7071.0, 6947.0, 6820.0, 
6691.0, 6561.0, 6428.0, 6293.0, 6157.0, 6018.0, 5878.0, 5736.0, 5592.0, 5446.0, 5299.0, 5150.0, 5000.0, 
4848.0, 4695.0, 4540.0, 4384.0, 4226.0, 4067.0, 3907.0, 3746.0, 3584.0, 3420.0, 3256.0, 3090.0, 2924.0, 
2756.0, 2588.0, 2419.0, 2250.0, 2079.0, 1908.0, 1736.0, 1564.0, 1392.0, 1219.0, 1045.0, 872.0, 698.0, 
523.0, 349.0, 175.0, 0.0, -175.0, -349.0, -523.0, -698.0, -872.0, -1045.0, -1219.0, -1392.0, -1564.0, 
-1736.0, -1908.0, -2079.0, -2250.0, -2419.0, -2588.0, -2756.0, -2924.0, -3090.0, -3256.0, -3420.0, 
-3584.0, -3746.0, -3907.0, -4067.0, -4226.0, -4384.0, -4540.0, -4695.0, -4848.0, -5000.0, -5150.0, 
-5299.0, -5446.0, -5592.0, -5736.0, -5878.0, -6018.0, -6157.0, -6293.0, -6428.0, -6561.0, -6691.0, 
-6820.0, -6947.0, -7071.0, -7193.0, -7314.0, -7431.0, -7547.0, -7660.0, -7771.0, -7880.0, -7986.0, 
-8090.0, -8192.0, -8290.0, -8387.0, -8480.0, -8572.0, -8660.0, -8746.0, -8829.0, -8910.0, -8988.0, 
-9063.0, -9135.0, -9205.0, -9272.0, -9336.0, -9397.0, -9455.0, -9511.0, -9563.0, -9613.0, -9659.0, 
-9703.0, -9744.0, -9781.0, -9816.0, -9848.0, -9877.0, -9903.0, -9925.0, -9945.0, -9962.0, -9976.0, 
-9986.0, -9994.0, -9998.0, -10000.0, -9998.0, -9994.0, -9986.0, -9976.0, -9962.0, -9945.0, -9925.0, 
-9903.0, -9877.0, -9848.0, -9816.0, -9781.0, -9744.0, -9703.0, -9659.0, -9613.0, -9563.0, -9511.0, 
-9455.0, -9397.0, -9336.0, -9272.0, -9205.0, -9135.0, -9063.0, -8988.0, -8910.0, -8829.0, -8746.0, 
-8660.0, -8572.0, -8480.0, -8387.0, -8290.0, -8192.0, -8090.0, -7986.0, -7880.0, -7771.0, -7660.0, 
-7547.0, -7431.0, -7314.0, -7193.0, -7071.0, -6947.0, -6820.0, -6691.0, -6561.0, -6428.0, -6293.0, 
-6157.0, -6018.0, -5878.0, -5736.0, -5592.0, -5446.0, -5299.0, -5150.0, -5000.0, -4848.0, -4695.0, 
-4540.0, -4384.0, -4226.0, -4067.0, -3907.0, -3746.0, -3584.0, -3420.0, -3256.0, -3090.0, -2924.0, 
-2756.0, -2588.0, -2419.0, -2250.0, -2079.0, -1908.0, -1736.0, -1564.0, -1392.0, -1219.0, -1045.0, 
-872.0, -698.0, -523.0, -349.0, -175.0, -0.0, 175.0, 349.0, 523.0, 698.0, 872.0, 1045.0, 1219.0, 
1392.0, 1564.0, 1736.0, 1908.0, 2079.0, 2250.0, 2419.0, 2588.0, 2756.0, 2924.0, 3090.0, 3256.0, 
3420.0, 3584.0, 3746.0, 3907.0, 4067.0, 4226.0, 4384.0, 4540.0, 4695.0, 4848.0, 5000.0, 5150.0, 
5299.0, 5446.0, 5592.0, 5736.0, 5878.0, 6018.0, 6157.0, 6293.0, 6428.0, 6561.0, 6691.0, 6820.0, 
6947.0, 7071.0, 7193.0, 7314.0, 7431.0, 7547.0, 7660.0, 7771.0, 7880.0, 7986.0, 8090.0, 8192.0, 
8290.0, 8387.0, 8480.0, 8572.0, 8660.0, 8746.0, 8829.0, 8910.0, 8988.0, 9063.0, 9135.0, 9205.0, 
9272.0, 9336.0, 9397.0, 9455.0, 9511.0, 9563.0, 9613.0, 9659.0, 9703.0, 9744.0, 9781.0, 9816.0, 
9848.0, 9877.0, 9903.0, 9925.0, 9945.0, 9962.0, 9976.0, 9986.0, 9994.0, 9998.0};

static const float a1  =  0.99997726f;
static const float a3  = -0.33262347f;
static const float a5  =  0.19354346f;
static const float a7  = -0.11643287f;
static const float a9  =  0.05265332f;
static const float a11 = -0.01172120f;

inline float atan_m(const float x) 
{
  float x_sq = x*x;
  return x * (a1 + x_sq * (a3 + x_sq * (a5 + x_sq * (a7 + x_sq * (a9 + x_sq * a11)))));
}

float sine_m(int32_t angle)
{
    while (angle < 0)
    {
        angle = 360 + angle;
    }
    while (angle >= 360)
    {
        angle = angle - 360;
    }
    return (float)sinedata[angle]/(float)sincosMax;
}

float cosine_m(int32_t angle)
{
    while (angle < 0)
    {
        angle = 360 + angle;
    }
    while (angle >= 360)
    {
        angle = angle - 360;
    }
    return (float)cosinedata[angle]/(float)sincosMax;
}

float atan2_m(const float ys, const float xs) 
{
    // Ensure input is in [-1, +1]
    float y = ys;
    float x = xs;
    bool swap = fabsf(x) < fabsf(y);
    float atan_input = (swap ? x : y) / (swap ? y : x);

    // Approximate atan
    float res = atan_m(atan_input);

    // If swapped, adjust atan output
    res = swap ? (atan_input >= 0.0f ? PI_D2 : -PI_D2) - res : res;
    // Adjust quadrants
    if      (x >= 0.0f && y >= 0.0f) {}                     // 1st quadrant
    else if (x <  0.0f && y >= 0.0f) { res =  PI + res; } // 2nd quadrant
    else if (x <  0.0f && y <  0.0f) { res = -PI + res; } // 3rd quadrant
    else if (x >= 0.0f && y <  0.0f) {}                     // 4th quadrant

    return res;
}

float sin_fast(const float x)
{
    const float B = 4*INVPI;
    const float C = -4*INVPISQ;

    float y = B * x + C * x * fabsf(x);

    //  const float Q = 0.775;
    const float P = 0.225;

    y = P * (y * fabsf(y) - y) + y;   // Q * y + P * y * abs(y)

    return y;
}

float cos_fast(const float x)
{
    return sin_fast(x + PI_D2);
}

// Parameters:
// y - Vector or scalar for numerator of ratio of which to determine the arctangent.
// x - Vector or scalar of denominator of ratio of which to determine the arctangent.
// Description
// atan2 calculates the arctangent of y/x. atan2 is well defined for every point other than the origin, even if x equals 0 and y does not equal 0.

// For vectors, the returned vector contains the arctangent of each element of the input vector.

// Reference Implementation
// atan2 for a float2 scalar could be implemented as an approximation like this.
float atan2_nvidia(const float y, const float x)
{
  float t3 = fabsf(x);
  float t1 = fabsf(y);
  float t0 = max(t3, t1);
  t1 = min(t3, t1);
  t3 = (1.f) / t0;
  t3 = t1 * t3;

  float t4 = t3 * t3;
  t0 =         - (0.013480470f);
  t0 = t0 * t4 + (0.057477314f);
  t0 = t0 * t4 - (0.121239071f);
  t0 = t0 * t4 + (0.195635925f);
  t0 = t0 * t4 - (0.332994597f);
  t0 = t0 * t4 + (0.999995630f);
  t3 = t0 * t3;

  t3 = (fabsf(y) > fabsf(x)) ? PI_D2 - t3 : t3;
  t3 = (x < 0) ?  PI - t3 : t3;
  t3 = (y < 0) ? -t3 : t3;

  return t3;
}

// Parameters
// a - Vector or scalar of which to determine the arcsine.
// Description
// Returns the arcsine of a in the range [-pi/2,+pi/2], expecting a to be in the range [-1,+1].

// For vectors, the returned vector contains the arcsine of each element of the input vector.

// Reference Implementation
// asin for a float scalar could be implemented like this.

// Handbook of Mathematical Functions
// M. Abramowitz and I.A. Stegun, Ed.
float asin_nvidia(const float x_) 
{
  float negate = (x_ < 0);
  float x = fabsf(x_);
  float ret = -0.0187293f;
  ret *= x;
  ret += 0.0742610f;
  ret *= x;
  ret -= 0.2121144f;
  ret *= x;
  ret += 1.5707288f;
  ret = PI*0.5f - sqrtf(1.f - x)*ret;
  return ret - 2 * negate * ret;
}

// Handbook of Mathematical Functions, M. Abramowitz and I.A. Stegun, Ed.
// a - Vector or scalar of which to determine the arccosine.
// Returns the arccosine of a in the range [0,pi], expecting a to be in the range [-1,+1].
float acos_nvidia(const float x_) 
{
  float negate = (float)(x_ < 0);
  float x = fabsf(x_);
  float ret = -0.0187293f;
  ret = ret * x;
  ret = ret + 0.0742610f;
  ret = ret * x;
  ret = ret - 0.2121144f;
  ret = ret * x;
  ret = ret + 1.5707288f;
  ret = ret * sqrtf(1.f-x);
  ret = ret - 2 * negate * ret;
  return negate * PI + ret;
}
